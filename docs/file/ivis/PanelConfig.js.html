<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">ivis/PanelConfig.js | ivis-core</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Just to make my dev environment a little easier to use."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="ivis-core"><meta property="twitter:description" content="Just to make my dev environment a little easier to use."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/dburian/ivis-core"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/AreaChart.js~AreaChart.html">AreaChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/BarChart.js~StaticBarChart.html">StaticBarChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/BubblePlot.js~BubblePlot.html">BubblePlot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/DataAccess.js~DataAccess.html">DataAccess</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/DataAccess.js~DataAccessSession.html">DataAccessSession</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/DataAccess.js~TimeSeriesPointProvider.html">TimeSeriesPointProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/DataAccess.js~TimeSeriesProvider.html">TimeSeriesProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/DataAccess.js~TimeSeriesSummaryProvider.html">TimeSeriesSummaryProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/DataPathApproximator.js~DataPathApproximator.html">DataPathApproximator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/FrequencyBarChart.js~FrequencyBarChart.html">FrequencyBarChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/FrequencyDataLoader.js~FrequencyDataLoader.html">FrequencyDataLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/FrequencyPieChart.js~FrequencyPieChart.html">FrequencyPieChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/HeatmapChart.js~HeatmapChart.html">HeatmapChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/HistogramChart.js~HistogramChart.html">HistogramChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/Legend.js~Legend.html">Legend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/Legend.js~StaticLegend.html">StaticLegend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/LineChart.js~LineChart.html">LineChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/LineChartBase.js~LineChartBase.html">LineChartBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/LiveAnimation.js~LiveAnimation.html">LiveAnimation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/MinMaxLoader.js~MinMaxLoader.html">MinMaxLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/OnOffAreaChart.js~OnOffAreaChart.html">OnOffAreaChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/PanelConfig.js~Configurator.html">Configurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/PanelConfig.js~PanelConfigAccess.html">PanelConfigAccess</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/PanelConfig.js~PdfExportDialog.html">PdfExportDialog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/PanelConfig.js~PermanentLinkDialog.html">PermanentLinkDialog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/PanelConfig.js~SaveDialog.html">SaveDialog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/PieChart.js~StaticPieChart.html">StaticPieChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/RecordedAnimation.js~RecordedAnimation.html">RecordedAnimation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/Records.js~Records.html">Records</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/SVG.js~SVG.html">SVG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/ScatterPlot.js~ScatterPlot.html">ScatterPlot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/ScatterPlotBase.js~ScatterPlotBase.html">ScatterPlotBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/Selector.js~SignalSelector.html">SignalSelector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/Selector.js~StaticSignalSelector.html">StaticSignalSelector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/TimeBasedChartBase.js~TimeBasedChartBase.html">TimeBasedChartBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/TimeContext.js~TimeContext.html">TimeContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/TimeInterval.js~IntervalAbsolute.html">IntervalAbsolute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/TimeInterval.js~IntervalHistory.html">IntervalHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/TimeInterval.js~IntervalSpec.html">IntervalSpec</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/TimeInterval.js~TimeInterval.html">TimeInterval</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/TimeRangeSelector.js~PredefTimeRangeSelector.html">PredefTimeRangeSelector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/TimeRangeSelector.js~TimeRangeSelector.html">TimeRangeSelector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/Tooltip.js~Tooltip.html">Tooltip</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-animated">animated</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-forAggs">forAggs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAxisIdx">getAxisIdx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineWithPointsOnHover">lineWithPointsOnHover</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineWithoutPoints">lineWithoutPoints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lineWithoutPointsAndPointsOnNoAggregation">lineWithoutPointsAndPointsOnNoAggregation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nolineWithPointsAlways">nolineWithPointsAlways</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createBase">createBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isSignalVisible">isSignalVisible</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-intervalAccessMixin">intervalAccessMixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-defaultGetMinAggregationInterval">defaultGetMinAggregationInterval</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ModifyColorCopy">ModifyColorCopy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-WheelDelta">WheelDelta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-brushHandlesLeftRight">brushHandlesLeftRight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-brushHandlesTopBottom">brushHandlesTopBottom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-distance">distance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extentWithMargin">extentWithMargin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getColorScale">getColorScale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getExtent">getExtent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isInExtent">isInExtent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isSignalVisible">isSignalVisible</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-roundTo">roundTo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setZoomTransform">setZoomTransform</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transitionInterpolate">transitionInterpolate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-fileUrl">fileUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AnimationControlContext">AnimationControlContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AnimationDataContext">AnimationDataContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AnimationStatusContext">AnimationStatusContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-withAnimationControl">withAnimationControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-withAnimationData">withAnimationData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-withAnimationStatus">withAnimationStatus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TimeSeriesPointPredefs">TimeSeriesPointPredefs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TimeSeriesPointType">TimeSeriesPointType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dataAccess">dataAccess</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PointsVisibility">PointsVisibility</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pointsOnNoAggregation">pointsOnNoAggregation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PanelConfigOwnerContext">PanelConfigOwnerContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-panelConfigAccessMixin">panelConfigAccessMixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-panelConfigMixin">panelConfigMixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-withPanelConfig">withPanelConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-panelMenuMixin">panelMenuMixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LegendPosition">LegendPosition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ConfigDifference">ConfigDifference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RenderStatus">RenderStatus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TimeIntervalsContext">TimeIntervalsContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ZoomEventSources">ZoomEventSources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dotShapeNames">dotShapeNames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dotShapes">dotShapes</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#attic">attic</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/attic/BarChart.js~BarChart.html">BarChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/attic/BarNavigator.js~LineNavigator.html">LineNavigator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ivis/attic/LineNavigator.js~BarNavigator.html">BarNavigator</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">ivis/PanelConfig.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import React, {Component} from &quot;react&quot;;
import Immutable from &apos;immutable&apos;;
import PropTypes from &quot;prop-types&quot;;
import {Trans} from &quot;react-i18next&quot;;
import {
    AlignedRow,
    Button,
    ButtonRow,
    Dropdown,
    filterData,
    Form,
    FormSendMethod,
    InputField,
    TableSelect,
    TextArea,
    withForm
} from &quot;../lib/form&quot;;
import &quot;brace/mode/html&quot;;
import &quot;brace/mode/json&quot;;
import {withAsyncErrorHandler, withErrorHandling, wrapWithAsyncErrorHandler} from &quot;../lib/error-handling&quot;;
import ParamTypes from &quot;../settings/ParamTypes&quot;
import {checkPermissions} from &quot;../lib/permissions&quot;;
import styles from &quot;./PanelConfig.scss&quot;;
import {panelMenuMixin} from &quot;./PanelMenu&quot;;
import {getTrustedUrl, getUrl} from &quot;../lib/urls&quot;;
import axios from &quot;../lib/axios&quot;;
import moment from &quot;moment/moment&quot;;
import {NamespaceSelect, validateNamespace} from &quot;../lib/namespace&quot;;
import {ActionLink} from &quot;../lib/bootstrap-components&quot;;
import {withPageHelpers} from &quot;../lib/page-common&quot;;
import {createComponentMixin, withComponentMixins} from &quot;../lib/decorator-helpers&quot;;
import {withTranslation} from &quot;../lib/i18n&quot;;
import {createPermanentLink, createPermanentLinkData} from &quot;../lib/permanent-link&quot;;

export const PanelConfigOwnerContext = React.createContext(null);

export const panelConfigAccessMixin = createComponentMixin({
    contexts: [{
        context: PanelConfigOwnerContext,
        propName: &apos;panelConfigOwner&apos;
    }],
    decoratorFn: (TargetClass, InnerClass) =&gt; {
        return {};
    }
});

@withComponentMixins([
    withTranslation,
    withForm
])
export class Configurator extends Component {
    constructor(props) {
        super(props);

        this.state = {
            initialized: false
        };

        this.initForm({
            onChangeBeforeValidation: ::this.onChangeBeforeValidation,
            onChange: ::this.onChangeCallback
        });

        this.paramTypes = new ParamTypes(props.t);
    }

    static propTypes = {
        configSpec: PropTypes.oneOfType([PropTypes.array, PropTypes.object]).isRequired,
        config: PropTypes.oneOfType([PropTypes.array, PropTypes.object]).isRequired,
        autoApply: PropTypes.bool,
        onChange: PropTypes.func.isRequired,
        onCloseAsync: PropTypes.func
    }

    componentDidMount() {
        const data = {};
        this.paramTypes.setFields(this.props.configSpec, this.props.config, data);
        this.populateFormValues(data);
        this.setState({
            initialized: true
        });
    }

    onChangeBeforeValidation(mutStateData, key, oldVal, newVal) {
        this.paramTypes.onChange(this.props.configSpec, mutStateData, key, oldVal, newVal)
    }

    onChangeCallback(state, key, oldValue, value) {
        if (this.props.autoApply &amp;&amp; !state.formState.get(&apos;data&apos;).find(attr =&gt; attr.get(&apos;error&apos;))) { // If form is without errors
            const config = this.paramTypes.getParams(this.props.configSpec, state.formState.get(&apos;data&apos;).map(attr =&gt; attr.get(&apos;value&apos;)).toJS()); // Get form values
            this.props.onChange(this.paramTypes.upcast(this.props.configSpec, config));
        }
    }

    localValidateFormValues(state) {
        const t = this.props.t;

        const paramPrefix = this.paramTypes.getParamPrefix();
        for (const paramId of state.keys()) {
            if (paramId.startsWith(paramPrefix)) {
                state.deleteIn([paramId, &apos;error&apos;]);
            }
        }

        this.paramTypes.localValidate(this.props.configSpec, state);
    }

    async submitHandler() {
        const t = this.props.t;

        try {
            this.disableForm();

            // await this.waitForFormServerValidated(); - This is not needed at the moment, but we keep it here as a reminder to wait for server validation here if we start using server validation for panel config

            if (this.isFormWithoutErrors()) {
                const config = this.paramTypes.getParams(this.props.configSpec, this.getFormValues());
                this.props.onChange(this.paramTypes.upcast(this.props.configSpec, config));

                this.enableForm();
                this.clearFormStatusMessage();
                this.hideFormValidation();

                this.close();
            } else {
                this.showFormValidation();
                this.enableForm();
                this.setFormStatusMessage(&apos;warning&apos;, t(&apos;There are errors in the form. Please fix them and try again.&apos;));
            }
        } catch (error) {
            throw error;
        }
    }

    async close() {
        if (this.props.onCloseAsync) {
            await this.props.onCloseAsync();
        }
    }

    render() {
        const t = this.props.t;

        if (this.state.initialized) {
            const params = this.paramTypes.render(this.props.configSpec, this);

            let buttons;

            if (this.props.autoApply) {
                buttons = (
                    &lt;ButtonRow&gt;
                        &lt;Button className=&quot;btn-primary&quot; icon=&quot;check&quot; label={t(&apos;Close&apos;)} onClickAsync={::this.close}/&gt;
                    &lt;/ButtonRow&gt;
                );
            } else {
                buttons = (
                    &lt;ButtonRow&gt;
                        &lt;Button type=&quot;submit&quot; className=&quot;btn-primary&quot; icon=&quot;check&quot; label={t(&apos;Apply&apos;)}/&gt;
                        &lt;Button className=&quot;btn-danger&quot; icon=&quot;ban&quot; label={t(&apos;Cancel&apos;)} onClickAsync={::this.close}/&gt;
                    &lt;/ButtonRow&gt;
                );
            }

            return (
                &lt;Form stateOwner={this} onSubmitAsync={::this.submitHandler}&gt;
                    {params}
                    {buttons}
                &lt;/Form&gt;
            );
        } else {
            return null;
        }
    }
}


const SaveDialogType = {
    NONE: 0,
    SAVE: 1,
    SAVE_COPY: 2
};

function openSaveDialog(owner, dialog) {
    owner.updatePanelState([&apos;saveDialog&apos;], dialog);

    if (dialog === SaveDialogType.NONE) {
        owner.updatePanelMenuEnabled({
            save: true,
            saveAs: true,
            saveCopy: true
        });
    } else {
        owner.updatePanelMenuEnabled({
            save: false,
            saveAs: false,
            saveCopy: false
        });
    }
}

@withComponentMixins([
    withTranslation,
    withPageHelpers,
    withForm,
    panelConfigAccessMixin
])
export class SaveDialog extends Component {
    constructor(props) {
        super(props);

        this.state = {
            message: null
        };

        this.initForm({
            onChange: {
                workspace: (newState, key, oldValue, newValue) =&gt; ::this.fetchPanelsVisible(newValue)
            }
        });
    }

    @withAsyncErrorHandler
    async fetchPanelsVisible(workspaceId) {
        this.setState({
            panelsVisible: []
        });

        if (workspaceId) {
            const result = await axios.get(getUrl(`rest/panels-visible/${workspaceId}`));

            this.setState({
                panelsVisible: result.data
            });
        }
    }

    componentDidMount() {
        const owner = this.props.panelConfigOwner;

        this.fetchPanelsVisible(owner.props.panel.workspace);

        this.populateFormValues({
            name: &apos;&apos;,
            description: &apos;&apos;,
            workspace: owner.props.panel.workspace,
            namespace: owner.props.panel.namespace,
            orderBefore: &apos;end&apos;
        });
    }

    localValidateFormValues(state) {
        const t = this.props.t;
        const owner = this.props.panelConfigOwner;
        const dialog = owner.getPanelState([&apos;saveDialog&apos;]);

        if (dialog === SaveDialogType.SAVE_COPY) {
            if (!state.getIn([&apos;name&apos;, &apos;value&apos;])) {
                state.setIn([&apos;name&apos;, &apos;error&apos;], t(&apos;Name must not be empty&apos;));
            } else {
                state.setIn([&apos;name&apos;, &apos;error&apos;], null);
            }

            if (!state.getIn([&apos;workspace&apos;, &apos;value&apos;])) {
                state.setIn([&apos;workspace&apos;, &apos;error&apos;], t(&apos;Workspace must be selected&apos;));
            } else {
                state.setIn([&apos;workspace&apos;, &apos;error&apos;], null);
            }

            validateNamespace(t, state);
        }
    }

    submitFormValuesMutator(data) {
        const owner = this.props.panelConfigOwner;
        data.template = owner.props.panel.template;
        data.builtin_template = owner.props.panel.builtin_template;
        data.params = owner.getPanelConfig();
        data.orderBefore = Number.parseInt(data.orderBefore) || data.orderBefore;
        return filterData(data, [
            &apos;name&apos;,
            &apos;description&apos;,
            &apos;workspace&apos;,
            &apos;orderBefore&apos;,
            &apos;params&apos;,
            &apos;template&apos;,
            &apos;builtin_template&apos;,
            &apos;template&apos;,
            &apos;namespace&apos;
        ]);
    }

    async submitHandler() {
        const t = this.props.t;
        const owner = this.props.panelConfigOwner;
        const dialog = owner.getPanelState([&apos;saveDialog&apos;]);

        try {
            if (dialog === SaveDialogType.SAVE) {
                this.disableForm();
                this.setFormStatusMessage(&apos;info&apos;, t(&apos;Saving ...&apos;));

                // FIXME id can be virtual -&gt; panel doesn&apos;t exists so saving will result in error
                await axios.put(getUrl(`rest/panels-config/${owner.props.panel.id}`), owner.getPanelConfig());

                this.enableForm();
                this.clearFormStatusMessage();

                this.close();

            } else if (dialog === SaveDialogType.SAVE_COPY) {
                this.disableForm();
                this.setFormStatusMessage(&apos;info&apos;, t(&apos;Saving ...&apos;));

                const workspaceId = this.getFormValue(&apos;workspace&apos;);

                const newPanelId = await this.validateAndSendFormValuesToURL(FormSendMethod.POST, `rest/panels/${workspaceId}`);

                if (newPanelId) {
                    this.setState({
                        message: &lt;Trans&gt;Panel saved. Click &lt;ActionLink
                            href={getTrustedUrl(`workspaces/${workspaceId}/${newPanelId}`)}
                            onClickAsync={async () =&gt; this.navigateTo(`/workspaces/${workspaceId}/${newPanelId}`)}&gt;here&lt;/ActionLink&gt; to
                            open it.&lt;/Trans&gt; // FIXME - make the action link tell parent to navigate to the url
                    });

                    this.enableForm();
                    this.clearFormStatusMessage();

                } else {
                    this.enableForm();
                    this.setFormStatusMessage(&apos;warning&apos;, t(&apos;There are errors in the form. Please fix them and submit again.&apos;));
                }
            }
        } catch (error) {
            throw error;
        }
    }

    async close() {
        const owner = this.props.panelConfigOwner;
        this.populateFormValues({
            name: &apos;&apos;,
            description: &apos;&apos;,
            workspace: owner.props.panel.workspace,
            namespace: owner.props.panel.namespace,
            orderBefore: &apos;end&apos;
        });

        this.setState({
            message: null
        });

        openSaveDialog(owner, SaveDialogType.NONE);
    }

    render() {
        const t = this.props.t;
        const owner = this.props.panelConfigOwner;

        const dialog = owner.getPanelState([&apos;saveDialog&apos;]);

        if (this.state.message) {
            return (
                &lt;div className={styles.saveWidget}&gt;
                    &lt;Form stateOwner={this} onSubmitAsync={::this.submitHandler}&gt;
                        &lt;legend&gt;{t(&apos;Save panel settings&apos;)}&lt;/legend&gt;

                        &lt;AlignedRow&gt;{this.state.message}&lt;/AlignedRow&gt;

                        &lt;ButtonRow&gt;
                            &lt;Button className=&quot;btn-primary&quot; icon=&quot;check&quot; label={t(&apos;OK&apos;)} onClickAsync={::this.close}/&gt;
                        &lt;/ButtonRow&gt;
                    &lt;/Form&gt;
                &lt;/div&gt;
            );

        } else if (dialog === SaveDialogType.SAVE) {
            return (
                &lt;div className={styles.saveWidget}&gt;
                    &lt;Form stateOwner={this} onSubmitAsync={::this.submitHandler}&gt;
                        &lt;legend&gt;{t(&apos;Save panel settings&apos;)}&lt;/legend&gt;

                        &lt;AlignedRow&gt;{t(&apos;Do you want to overwrite the existing panel settings?&apos;)}&lt;/AlignedRow&gt;

                        &lt;ButtonRow&gt;
                            &lt;Button type=&quot;submit&quot; className=&quot;btn-primary&quot; icon=&quot;check&quot; label={t(&apos;Save&apos;)}/&gt;
                            &lt;Button className=&quot;btn-danger&quot; icon=&quot;ban&quot; label={t(&apos;Cancel&apos;)} onClickAsync={::this.close}/&gt;
                        &lt;/ButtonRow&gt;
                    &lt;/Form&gt;
                &lt;/div&gt;
            );

        } else if (dialog === SaveDialogType.SAVE_COPY) {
            const templateColumns = [
                {data: 1, title: t(&apos;Name&apos;)},
                {data: 2, title: t(&apos;Description&apos;)},
                {data: 5, title: t(&apos;Created&apos;), render: data =&gt; moment(data).fromNow()}
            ];

            const workspaceColumns = [
                {data: 1, title: t(&apos;#&apos;)},
                {data: 2, title: t(&apos;Name&apos;)},
                {data: 3, title: t(&apos;Description&apos;)},
                {data: 4, title: t(&apos;Created&apos;), render: data =&gt; moment(data).fromNow()}
            ];

            const panel = owner.props.panel;

            const orderOptions = [
                {key: &apos;none&apos;, label: t(&apos;Not visible&apos;)},
                ...this.state.panelsVisible.map(x =&gt; ({key: x.id.toString(), label: x.name})),
                {key: &apos;end&apos;, label: t(&apos;End of list&apos;)}
            ];

            return (
                &lt;div className={styles.saveWidget}&gt;
                    &lt;Form stateOwner={this} onSubmitAsync={::this.submitHandler}&gt;
                        &lt;legend&gt;{t(&apos;Save panel settings&apos;)}&lt;/legend&gt;

                        &lt;InputField id=&quot;name&quot; label={t(&apos;Name&apos;)}/&gt;
                        &lt;TextArea id=&quot;description&quot; label={t(&apos;Description&apos;)} help={t(&apos;HTML is allowed&apos;)}/&gt;
                        &lt;TableSelect id=&quot;workspace&quot; label={t(&apos;Workspace&apos;)} withHeader dropdown
                                     dataUrl=&quot;rest/workspaces-table&quot; columns={workspaceColumns}
                                     selectionLabelIndex={2}/&gt;
                        &lt;NamespaceSelect/&gt;
                        &lt;Dropdown id=&quot;orderBefore&quot; label={t(&apos;Order (before)&apos;)} options={orderOptions}
                                  help={t(&apos;Select the panel before which this panel should appear in the menu. To exclude the panel from listings, select &quot;Not visible&quot;.&apos;)}/&gt;

                        &lt;ButtonRow&gt;
                            &lt;Button type=&quot;submit&quot; className=&quot;btn-primary&quot; icon=&quot;check&quot; label={t(&apos;Save&apos;)}/&gt;
                            &lt;Button className=&quot;btn-danger&quot; icon=&quot;ban&quot; label={t(&apos;Cancel&apos;)} onClickAsync={::this.close}/&gt;
                        &lt;/ButtonRow&gt;
                    &lt;/Form&gt;
                &lt;/div&gt;
            );
        } else {
            return null;
        }
    }
}


function openPermanentLinkDialog(owner, opened) {
    owner.updatePanelState([&apos;permanentLinkDialog&apos;], opened);
}

@withComponentMixins([
    withTranslation,
    panelConfigAccessMixin
])
export class PermanentLinkDialog extends Component {
    render() {
        const t = this.props.t;
        const owner = this.props.panelConfigOwner;

        const opened = owner.getPanelState([&apos;permanentLinkDialog&apos;]);

        const panelId = owner.props.panel.id;
        const workspaceId = owner.props.panel.workspace;

        const panelState = owner.getPanelState();
        const panelConfig = owner.getPanelConfig();
        delete panelState.permanentLinkDialog;

        const link = createPermanentLink(getTrustedUrl(`workspaces/${workspaceId}/${panelId}`), panelConfig, panelState);

        if (opened) {
            return (
                &lt;div className={styles.permanentLinkWidget}&gt;

                    &lt;h3&gt;{t(&apos;Permanent link&apos;)}&lt;/h3&gt;

                    &lt;textarea rows={7} value={link} readOnly/&gt;

                    &lt;div className={styles.buttonRow}&gt;
                        &lt;Button className=&quot;btn-primary&quot; icon=&quot;check&quot; label={t(&apos;OK&apos;)}
                                onClickAsync={async () =&gt; openPermanentLinkDialog(owner, false)}/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            );

        } else {
            return null;
        }
    }
}


function openPdfExportDialog(owner, opened) {
    owner.updatePanelState([&apos;pdfExportDialog&apos;], opened);
}

@withComponentMixins([
    withTranslation,
    withErrorHandling,
    withForm,
    panelConfigAccessMixin
])
export class PdfExportDialog extends Component {
    constructor(props) {
        super(props);

        this.state = {
            isExportRunning: false
        };

        this.initForm({});

        this.refreshTimeout = null;
        this.epoch = 0;
    }

    componentDidMount() {
        const owner = this.props.panelConfigOwner;

        this.populateFormValues({
            pageSize: &apos;A4&apos;
        });
    }

    @withAsyncErrorHandler
    async callExport(requestParams) {
        const owner = this.props.panelConfigOwner;
        const currentEpoch = this.epoch;

        if (!requestParams) {
            const frozenPanelState = owner.getFrozenPanelState();
            const frozenPanelConfig = owner.getFrozenPanelConfig();

            delete frozenPanelState.pdfExportDialog;

            requestParams = {
                permanentLink: createPermanentLinkData(frozenPanelConfig, frozenPanelState),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
        }

        const result = await axios.post(getUrl(`rest/panel-pdf/${owner.props.panel.id}`), requestParams);

        if (currentEpoch === this.epoch) {
            const pdfKey = result.data;

            if (pdfKey) {
                this.setState({
                    isExportRunning: false
                });

                const aElem = document.createElement(&apos;a&apos;);
                aElem.style.display = &apos;none&apos;;
                aElem.href = getTrustedUrl(&apos;pdf-export/&apos; + pdfKey);
                document.body.appendChild(aElem);
                aElem.click();
                setImmediate(() =&gt; document.body.removeChild(aElem));

            } else {
                this.setState({
                    isExportRunning: true
                });

                this.refreshTimeout = setTimeout(() =&gt; {
                    this.callExport(requestParams);
                }, 1 * 1000);
            }
        }
    }

    async submitHandler() {
        const t = this.props.t;
        const owner = this.props.panelConfigOwner;

        try {
            this.disableForm();

            this.callExport();

            this.enableForm();
            this.clearFormStatusMessage();

        } catch (error) {
            throw error;
        }
    }

    async close() {
        const owner = this.props.panelConfigOwner;

        this.epoch += 1;
        clearTimeout(this.refreshTimeout);

        this.setState({
            isExportRunning: false
        });

        openPdfExportDialog(owner, false);
    }

    componentWillUnmount() {
        clearTimeout(this.refreshTimeout);
    }

    render() {
        const t = this.props.t;
        const owner = this.props.panelConfigOwner;

        const opened = owner.getPanelState([&apos;pdfExportDialog&apos;]);

        if (opened) {
            const isExportRunning = this.state.isExportRunning;

            let exportButton;
            if (!isExportRunning) {
                exportButton = &lt;Button type=&quot;submit&quot; className=&quot;btn-primary&quot; icon=&quot;check&quot; label={t(&apos;Export PDF&apos;)}/&gt;;
            } else {
                exportButton = &lt;Button type=&quot;submit&quot; className=&quot;btn-primary&quot; icon=&quot;hourglass&quot; label={t(&apos;Exporting ...&apos;)}
                                       disabled/&gt;;
            }

            return (
                &lt;div className={styles.pdfExportWidget}&gt;
                    &lt;Form stateOwner={this} onSubmitAsync={::this.submitHandler}&gt;
                        &lt;legend&gt;{t(&apos;Export PDF&apos;)}&lt;/legend&gt;

                        &lt;ButtonRow&gt;
                            {exportButton}
                            &lt;Button className=&quot;btn-danger&quot; icon=&quot;ban&quot; label={t(&apos;Close&apos;)} onClickAsync={::this.close} /&gt;
                        &lt;/ButtonRow&gt;
                    &lt;/Form&gt;
                &lt;/div&gt;
            );
        } else {
            return null;
        }
    }
}


export const panelConfigMixin = createComponentMixin({
    deps: [withErrorHandling, panelMenuMixin, withTranslation],
    decoratorFn: (TargetClass, InnerClass) =&gt; {
        const inst = InnerClass.prototype;

        function ctor(self, props) {
            if (!self.state) {
                self.state = {};
            }

            self.state._panelConfig = Immutable.Map({
                params: Immutable.fromJS(props.params),
                state: Immutable.fromJS(props.state || {}),
                savePermitted: false
            });

            self._panelConfig = {
                configFreezeHandlers: new Set(),
                stateFreezeHandlers: new Set()
            }
        }

        const previousComponentDidUpdate = inst.componentDidUpdate;
        inst.componentDidUpdate = function (prevProps, prevState, snapshot) {
            if (this.props.params !== prevProps.params) {
                this.setState(state =&gt; ({
                    _panelConfig: state._panelConfig
                        .set(&apos;params&apos;, Immutable.fromJS(this.props.params))
                }));
            }

            if (previousComponentDidUpdate) {
                previousComponentDidUpdate.apply(this, prevProps, prevState, snapshot);
            }
        };

        const previousComponentDidMount = inst.componentDidMount;
        inst.componentDidMount = function () {
            const t = this.props.t;

            const fetchPermissions = wrapWithAsyncErrorHandler(this, async () =&gt; {
                const result = await checkPermissions({
                    editPanel: {
                        entityTypeId: &apos;panel&apos;,
                        entityId: this.props.panel.id,
                        requiredOperations: [&apos;edit&apos;]
                    },
                    createPanel: {
                        entityTypeId: &apos;namespace&apos;,
                        requiredOperations: [&apos;createPanel&apos;]
                    }
                });

                const savePermitted = result.data.editPanel;
                const saveAsPermitted = result.data.createPanel;
                this.setState(state =&gt; ({
                    _panelConfig: state._panelConfig
                        .set(&apos;savePermitted&apos;, savePermitted)
                        .set(&apos;saveAsPermitted&apos;, saveAsPermitted)
                }));

                const menuUpdates = {};
                if (savePermitted) {
                    menuUpdates[&apos;save&apos;] = {
                        label: t(&apos;Save&apos;),
                        action: () =&gt; openSaveDialog(this, SaveDialogType.SAVE),
                        weight: 10
                    };
                }

                if (saveAsPermitted) {
                    menuUpdates[&apos;saveCopy&apos;] = {
                        label: t(&apos;Save Copy&apos;),
                        action: () =&gt; openSaveDialog(this, SaveDialogType.SAVE_COPY),
                        weight: 11
                    };
                }

                menuUpdates[&apos;pdfExport&apos;] = {
                    label: t(&apos;Export PDF&apos;),
                    action: () =&gt; openPdfExportDialog(this, true),
                    weight: 12
                };

                menuUpdates[&apos;permanentLink&apos;] = {
                    label: t(&apos;Permanent Link&apos;),
                    action: () =&gt; openPermanentLinkDialog(this, true),
                    weight: 13
                };

                this.updatePanelMenu(menuUpdates);
            });

            fetchPermissions();

            if (previousComponentDidMount) {
                previousComponentDidMount.apply(this);
            }
        };

        const previousRender = inst.render;
        inst.render = function () {
            return (
                &lt;PanelConfigOwnerContext.Provider value={this}&gt;
                    {&lt;PdfExportDialog/&gt;}
                    {&lt;PermanentLinkDialog/&gt;}
                    {(this.isPanelConfigSavePermitted() || this.isPanelConfigSaveAsPermitted()) &amp;&amp; &lt;SaveDialog/&gt;}
                    {previousRender.apply(this)}
                &lt;/PanelConfigOwnerContext.Provider&gt;
            );
        };

        inst.isPanelConfigSavePermitted = function () {
            return this.state._panelConfig.get(&apos;savePermitted&apos;);
        };

        inst.isPanelConfigSaveAsPermitted = function () {
            return this.state._panelConfig.get(&apos;saveAsPermitted&apos;);
        };

        inst.registerPanelConfigFreezeHandler = function (handler) {
            this._panelConfig.configFreezeHandlers.add(handler);
        };

        inst.unregisterPanelConfigFreezeHandler = function (handler) {
            this._panelConfig.configFreezeHandlers.delete(handler);
        };

        inst.registerPanelStateFreezeHandler = function (handler) {
            this._panelConfig.stateFreezeHandlers.add(handler);
        };

        inst.unregisterPanelStateFreezeHandler = function (handler) {
            this._panelConfig.stateFreezeHandlers.delete(handler);
        };

        inst.getPanelConfig = function (path = []) {
            const value = this.state._panelConfig.getIn([&apos;params&apos;, ...path]);
            if (Immutable.isImmutable(value)) {
                return value.toJS();
            } else {
                return value;
            }
        };

        inst.getFrozenPanelConfig = function () {
            let value = this.state._panelConfig.get(&apos;params&apos;).toJS();
            for (const handler of this._panelConfig.configFreezeHandlers.keys()) {
                value = handler(value);
            }

            return value;
        };

        inst.updatePanelConfig = function (path, newValue) {
            this.setState(state =&gt; ({
                _panelConfig: state._panelConfig.setIn([&apos;params&apos;, ...path], Immutable.fromJS(newValue))
            }));
        };

        inst.getPanelState = function (path = []) {
            const value = this.state._panelConfig.getIn([&apos;state&apos;, ...path]);
            if (Immutable.isImmutable(value)) {
                return value.toJS();
            } else {
                return value;
            }
        };

        inst.getFrozenPanelState = function () {
            let value = this.state._panelConfig.get(&apos;state&apos;).toJS();
            for (const handler of this._panelConfig.stateFreezeHandlers.keys()) {
                value = handler(value);
            }

            return value;
        };

        inst.updatePanelState = function (path, newValue) {
            this.setState(state =&gt; ({
                _panelConfig: state._panelConfig.setIn([&apos;state&apos;, ...path], Immutable.fromJS(newValue))
            }));
        };

        return {
            ctor
        };
    }
});


export const withPanelConfig = withComponentMixins([
   panelConfigMixin
]);


@withComponentMixins([
    panelConfigAccessMixin
])
export class PanelConfigAccess extends Component {
    constructor(props) {
        super(props);
    }

    static propTypes = {
        configPath: PropTypes.array,
        statePath: PropTypes.array,
        render: PropTypes.func.isRequired
    }

    render() {
        const owner = this.props.panelConfigOwner;

        if (this.props.configPath) {
            return this.props.render(
                owner.getPanelConfig(this.props.configPath),
                (path, newValue) =&gt; {
                    owner.updatePanelConfig([...this.props.configPath, ...path], newValue);
                },
                owner.isPanelConfigSavePermitted()
            );
        } else {
            return this.props.render(
                owner.getPanelState(this.props.statePath),
                (path, newValue) =&gt; {
                    owner.updatePanelState([...this.props.statePath, ...path], newValue);
                }
            );
        }
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
